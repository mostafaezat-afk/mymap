<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿØŸÑŸäŸÑ ÿÆÿØŸÖÿßÿ™ ÿ®ÿ¥ÿ™ŸäŸÑ</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts (Tajawal) -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --bg-overlay: rgba(0, 0, 0, 0.85);
            --primary: #2196f3;
            --primary-dark: #1976d2;
            --accent: #f44336;
            --success: #00c853;
            --text-main: #ffffff;
            --text-sec: #b0b0b0;
            --border: #333333;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            --radius: 16px;
            --font-main: 'Tajawal', sans-serif;
            --header-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Map Container --- */
        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
            background: #222;
        }

        .map-wrap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* --- Header --- */
        .app-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0) 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000;
            pointer-events: none;
            /* Let clicks pass through except buttons */
        }

        .header-title {
            font-weight: 800;
            font-size: 1.2rem;
            color: var(--text-main);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.4);
            padding: 5px 10px;
            border-radius: 8px;
            backdrop-filter: blur(4px);
        }

        .header-actions {
            pointer-events: auto;
            display: flex;
            gap: 10px;
        }

        .btn {
            border: none;
            border-radius: 50px;
            padding: 8px 16px;
            font-family: var(--font-main);
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #2e7d32);
            color: white;
        }

        .btn-glass {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* --- Bottom Panel (Search & Results) --- */
        .bottom-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 85%;
            /* Increased height for mobile */
            background: var(--bg-card);
            border-radius: 24px 24px 0 0;
            z-index: 900;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            /* Default state: showing search bar + some categories */
            transform: translateY(calc(100% - 200px));
            /* Show more by default */
        }

        .bottom-panel.expanded {
            transform: translateY(0);
            height: 85%;
        }

        /* Desktop override */
        @media (min-width: 768px) {
            .bottom-panel {
                top: 80px;
                left: 20px;
                bottom: 20px;
                width: 400px;
                max-height: calc(100% - 100px);
                transform: translateX(-110%);
                border-radius: 16px;
                height: auto;
            }

            .bottom-panel.active-desktop {
                transform: translateX(0);
            }

            /* Reset transform for desktop logic */
            .bottom-panel.expanded {
                transform: translateX(0);
                height: auto;
            }
        }

        .panel-handle {
            width: 50px;
            height: 6px;
            background: #444;
            border-radius: 10px;
            margin: 12px auto;
            cursor: pointer;
            flex-shrink: 0;
        }

        .search-container {
            padding: 0 15px 10px;
            flex-shrink: 0;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border-radius: 12px;
            background: #2a2a2a;
            border: 1px solid var(--border);
            color: white;
            font-family: var(--font-main);
            font-size: 1rem;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-sec);
        }

        /* Categories Grid */
        .categories-scroll {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            /* 4 columns for mobile */
            gap: 10px;
            padding: 0 0 10px;
            max-height: 250px;
            overflow-y: auto;
        }

        @media (max-width: 380px) {
            .categories-scroll {
                grid-template-columns: repeat(3, 1fr);
                /* 3 cols for very small screens */
            }
        }

        .cat-chip {
            background: #2a2a2a;
            border: 1px solid var(--border);
            padding: 10px 5px;
            border-radius: 12px;
            color: var(--text-sec);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
            font-size: 0.85rem;
            min-height: 80px;
        }

        .cat-chip span {
            font-size: 1.8rem;
        }

        .cat-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
            transform: translateY(-2px);
        }

        .results-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 15px 15px;
        }

        .result-item {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-right: 4px solid var(--primary);
            cursor: pointer;
        }

        .result-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .result-meta {
            font-size: 0.9rem;
            color: var(--text-sec);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .result-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-main);
            font-family: var(--font-main);
            cursor: pointer;
        }

        /* --- Modal (Add Service) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: var(--bg-card);
            width: 90%;
            max-width: 500px;
            border-radius: var(--radius);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-sec);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: #121212;
            border: 1px solid var(--border);
            border-radius: 10px;
            color: white;
            font-family: var(--font-main);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .map-picker {
            height: 200px;
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
            border: 1px solid var(--border);
        }

        .center-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            z-index: 500;
            font-size: 2rem;
            pointer-events: none;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.5));
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        /* --- Loading & Toast --- */
        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
            display: none;
        }

        .loader.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            z-index: 4000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            font-weight: 700;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            display: block;
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--accent);
        }

        /* Custom Marker */
        .custom-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>

<body>

    <div class="map-wrap">
        <div id="map"></div>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-title">üîç ÿÆÿØŸÖÿßÿ™ ÿ®ÿ¥ÿ™ŸäŸÑ</div>
        <div class="header-actions">
            <button class="btn btn-glass" onclick="app.toggleSearchPanel()">
                <i class="fa-solid fa-search"></i> <span style="display:none">ÿ®ÿ≠ÿ´</span>
            </button>
            <button class="btn btn-success" onclick="app.openAddModal()">
                <i class="fa-solid fa-plus"></i> <span>ÿ•ÿ∂ÿßŸÅÿ©</span>
            </button>
        </div>
    </header>

    <!-- Bottom Search Panel -->
    <div class="bottom-panel" id="search-panel">
        <div class="panel-handle" onclick="app.togglePanelExpand()"></div>
        <div class="search-container">
            <div class="search-box">
                <input type="text" class="search-input" id="search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿÆÿØŸÖÿ© (ÿµŸäÿØŸÑŸäÿ©ÿå ŸÖÿ∑ÿπŸÖ...)"
                    oninput="app.handleSearch(this.value)">
                <i class="fa-solid fa-search search-icon"></i>
            </div>

            <div class="categories-scroll" id="categories-container">
                <!-- Categories injected here -->
            </div>
        </div>

        <div class="results-list" id="results-list">
            <!-- Results injected here -->
            <div style="text-align:center; padding: 20px; color: #666;">
                <i class="fa-solid fa-map-location-dot" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.5;"></i>
                <p>ÿßÿÆÿ™ÿ± ŸÇÿ≥ŸÖÿßŸã ÿ£Ÿà ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿÆÿØŸÖÿ© ŸÑÿ∏ŸáŸàÿ± ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨</p>
            </div>
        </div>
    </div>

    <!-- Add Service Modal -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>ÿ•ÿ∂ÿßŸÅÿ© ÿÆÿØŸÖÿ© ÿ¨ÿØŸäÿØÿ©</span>
                <i class="fa-solid fa-times" style="cursor:pointer" onclick="app.closeAddModal()"></i>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ÿßÿ≥ŸÖ ÿßŸÑŸÜÿ¥ÿßÿ∑</label>
                    <input type="text" class="form-input" id="add-name" placeholder="ŸÖÿ´ÿßŸÑ: ÿµŸäÿØŸÑŸäÿ© ÿßŸÑŸÜŸàÿ±">
                </div>
                <div class="form-group">
                    <label class="form-label">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
                    <input type="tel" class="form-input" id="add-phone" placeholder="01xxxxxxxxx">
                </div>
                <div class="form-group" style="display:flex; gap:10px">
                    <div style="flex:1">
                        <label class="form-label">ÿßŸÑŸÇÿ≥ŸÖ</label>
                        <select class="form-input" id="add-category" onchange="app.updateActivitySelect()">
                            <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÇÿ≥ŸÖ</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label class="form-label">ÿßŸÑŸÜÿ¥ÿßÿ∑</label>
                        <select class="form-input" id="add-activity">
                            <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÜÿ¥ÿßÿ∑</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ÿßŸÑÿπŸÜŸàÿßŸÜ</label>
                    <input type="text" class="form-input" id="add-address" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ">
                </div>
                <div class="form-group">
                    <label class="form-label">ÿßŸÑŸÖŸàŸÇÿπ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© (ÿ≠ÿ±ŸÉ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©)</label>
                    <div class="map-picker">
                        <div id="picker-map" style="width:100%; height:100%"></div>
                        <div class="center-marker">üìç</div>
                    </div>
                    <div id="location-status" style="font-size:0.8rem; color:#888; text-align:center">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿØ
                        ÿßŸÑŸÖŸàŸÇÿπ...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-glass" style="color:white; background:transparent"
                    onclick="app.closeAddModal()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button class="btn btn-primary" style="flex:1; justify-content:center" onclick="app.submitService()">ÿ≠ŸÅÿ∏
                    ÿßŸÑÿÆÿØŸÖÿ©</button>
            </div>
        </div>
    </div>

    <!-- UI Elements -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
    </div>
    <div class="toast" id="toast"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const CONFIG = {
            SEARCH_API: 'https://script.google.com/macros/s/AKfycbzUWGPZPocJJoTSs-kVXsH-4w_Do5jjUIEDlzAws8U-McyvHd8VjAttHn34mSHDHZnl/exec',
            REGISTER_API: 'https://script.google.com/macros/s/AKfycbzUWGPZPocJJoTSs-kVXsH-4w_Do5jjUIEDlzAws8U-McyvHd8VjAttHn34mSHDHZnl/exec',
            CENTER: [30.08771, 31.18415], // Updated Center
            ZOOM: 16,
            // 3km radius restriction (approx +/- 0.03 degrees)
            MAX_BOUNDS: [
                [30.05771, 31.15415], // SouthWest
                [30.11771, 31.21415]  // NorthEast
            ]
        };

        const CATEGORIES = [
            { id: "all", icon: "üåü", label: "ÿßŸÑŸÉŸÑ" },
            { id: "food", icon: "üçΩÔ∏è", label: "ŸÖÿ£ŸÉŸàŸÑÿßÿ™" },
            { id: "grocery", icon: "üõí", label: "ÿ®ŸÇÿßŸÑÿ©" },
            { id: "services", icon: "üîß", label: "ÿÆÿØŸÖÿßÿ™" },
            { id: "shops", icon: "üè™", label: "ŸÖÿ≠ŸÑÿßÿ™" },
            { id: "medical", icon: "‚öïÔ∏è", label: "ÿ∑ÿ®Ÿä" },
            { id: "general", icon: "üìå", label: "ÿπÿßŸÖ" }
        ];

        const ACTIVITIES = {
            food: ["ŸÉÿ¥ÿ±Ÿä", "ŸÉÿ®ÿßÿ®ÿ¨Ÿä ŸàŸÖÿ¥ŸàŸäÿßÿ™", "ŸÅÿ±ÿßÿ±ÿ¨Ÿä", "ŸÖÿ≠ŸÑ ŸÅŸàŸÑ Ÿàÿ∑ÿπŸÖŸäÿ©", "ŸÖÿ≠ŸÑ ÿ£ÿ≥ŸÖÿßŸÉ", "ÿ®Ÿäÿ™ÿ≤ÿß ŸàŸÉÿ±Ÿäÿ®", "ÿ≠ŸÑŸàÿßŸÜŸä", "ŸÉÿßŸÅÿ™Ÿäÿ±Ÿäÿß ŸàŸÖÿ¥ÿ±Ÿàÿ®ÿßÿ™", "ÿπÿµŸäÿ±"],
            grocery: ["ÿ≥Ÿàÿ®ÿ± ŸÖÿßÿ±ŸÉÿ™", "ÿÆÿ∂ÿ±Ÿàÿßÿ™ ŸàŸÅÿßŸÉŸáÿ©", "ÿ¨ÿ≤ÿßÿ±", "ŸÖÿÆÿ®ÿ≤ ÿπŸäÿ¥", "ŸÅÿ±ŸÜ ÿ•ŸÅÿ±ŸÜÿ¨Ÿä", "ÿπÿ∑ÿßÿ±ÿ©", "ÿ™ŸÖŸàŸäŸÜ", "ÿ£ŸÑÿ®ÿßŸÜ"],
            services: ["ÿ≥ÿ®ÿßŸÉ", "ŸÉŸáÿ±ÿ®ÿßÿ¶Ÿä", "ÿµŸäÿßŸÜÿ© ÿ£ÿ¨Ÿáÿ≤ÿ© ŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ©", "ÿµŸäÿßŸÜÿ© ÿ≥ÿÆÿßŸÜÿßÿ™", "ÿµŸäÿßŸÜÿ© ŸÖŸàÿßÿ™Ÿäÿ± ŸÖŸäÿßŸá", "ÿµŸäÿßŸÜÿ© ŸÉŸÖÿ®ŸäŸàÿ™ÿ± ŸàŸÖÿ≠ŸÖŸàŸÑ", "ŸÜÿ¨ÿßÿ±", "ŸÜŸÇÿßÿ¥", "ŸÖŸäŸÉÿßŸÜŸäŸÉŸä ÿ≥Ÿäÿßÿ±ÿßÿ™", "ŸÅŸÜŸä ÿØÿ¥ Ÿàÿ≥ÿ™ÿßŸÑÿßŸäÿ™", "ŸÅŸÜŸä ÿ™ŸÉŸäŸäŸÅÿßÿ™", "ÿ≠ÿØÿßÿØ"],
            shops: ["ŸÖŸÑÿßÿ®ÿ≥", "ŸÖÿ≠ŸÑÿßÿ™ ŸÖÿ≠ŸÖŸàŸÑ", "ŸÖŸÉÿ™ÿ®ÿ© Ÿàÿ£ÿØŸàÿßÿ™ ŸÖÿØÿ±ÿ≥Ÿäÿ©", "ÿ≠ÿØÿßŸäÿØ Ÿàÿ®ŸàŸäÿßÿ™", "ÿ¨ŸàÿßŸáÿ±ÿ¨Ÿä", "ÿ£ÿØŸàÿßÿ™ ŸÖŸÜÿ≤ŸÑŸäÿ©", "ŸÖŸÜÿ∏ŸÅÿßÿ™ ŸàŸàÿ±ŸÇŸäÿßÿ™", "ÿ£ÿ≠ÿ∞Ÿäÿ© Ÿàÿ¥ŸÜÿ∑", "ŸÖŸÅÿ±Ÿàÿ¥ÿßÿ™", "ŸÉŸàÿßŸÅŸäÿ± ÿ≠ÿ±ŸäŸÖŸä", "ŸÉŸàÿßŸÅŸäÿ± ÿ±ÿ¨ÿßŸÑŸä", "ŸÖÿ≥ÿ™ÿ≠ÿ∂ÿ±ÿßÿ™ ÿ™ÿ¨ŸÖŸäŸÑ ŸàŸáÿØÿßŸäÿß", "ŸÑÿπÿ® ÿ£ÿ∑ŸÅÿßŸÑ"],
            medical: ["ÿ®ÿßÿ∑ŸÜÿ©", "ŸÇŸÑÿ®", "ÿ£ÿ∑ŸÅÿßŸÑ", "ÿπÿ∏ÿßŸÖ", "ÿ£ŸÜŸÅ Ÿàÿ£ÿ∞ŸÜ Ÿàÿ≠ŸÜÿ¨ÿ±ÿ©", "ŸÜÿ≥ÿßÿ° Ÿàÿ™ŸàŸÑŸäÿØ", "ÿπŸäŸàŸÜ", "ÿ¨ŸÑÿØŸäÿ©", "ÿ£ÿ≥ŸÜÿßŸÜ", "ŸÖÿÆ Ÿàÿ£ÿπÿµÿßÿ®", "ŸÖÿ≥ÿßŸÑŸÉ ÿ®ŸàŸÑŸäÿ©", "ÿπŸÑÿßÿ¨ ÿ∑ÿ®ŸäÿπŸä", "ÿ¨ÿ±ÿßÿ≠ÿ© ÿπÿßŸÖÿ©", "ŸÜŸÅÿ≥Ÿäÿ© Ÿàÿπÿµÿ®Ÿäÿ©", "ÿµÿØÿ±", "ÿ™ÿ∫ÿ∞Ÿäÿ© ÿπŸÑÿßÿ¨Ÿäÿ©", "ÿ≥ŸÉÿ± Ÿàÿ∫ÿØÿØ ÿµŸÖÿßÿ°", "ÿ∞ŸÉŸàÿ±ÿ© ŸàÿπŸÇŸÖ", "ÿ≥ŸÖÿπŸäÿßÿ™", "ÿ™ÿÆÿßÿ∑ÿ®", "ÿµŸäÿØŸÑŸäÿ©", "ŸÖÿπŸÖŸÑ ÿ™ÿ≠ÿßŸÑŸäŸÑ", "ŸÖÿ±ŸÉÿ≤ ÿ£ÿ¥ÿπÿ©", "ÿπŸäÿßÿØÿ© ÿ®Ÿäÿ∑ÿ±Ÿäÿ©"],
            general: ["ÿÆÿØŸÖÿßÿ™ ÿ™ŸàÿµŸäŸÑ", "ŸÖÿØÿ±ÿ≥ÿ©", "ŸÖÿ±ÿßŸÉÿ≤ ÿ™ŸÇŸàŸäÿ©", "ŸÖÿ≠ÿßŸÖŸä", "ÿ≥ŸÖÿ≥ÿßÿ±", "ÿπŸÇÿßÿ±ÿßÿ™", "ÿ®ŸÑÿßŸä ÿ≥ÿ™Ÿäÿ¥ŸÜ", "ÿ≥ŸÜÿ™ÿ±ÿßŸÑ", "ŸÖÿ§ÿ≥ÿ≥ÿßÿ™ ÿ≠ŸÉŸàŸÖŸäÿ©", "ŸÖÿ∫ÿ≥ŸÑÿ©", "ÿ≠ÿ∂ÿßŸÜÿ© ÿ£ÿ∑ŸÅÿßŸÑ", "ÿ•Ÿäÿ¨ÿßÿ± ÿ≥Ÿäÿßÿ±ÿßÿ™", "ÿ¨ŸäŸÖ", "ÿ≥ÿßŸäÿ®ÿ± ŸÜÿ™"]
        };

        class App {
            constructor() {
                this.map = null;
                this.pickerMap = null;
                this.markers = [];
                this.selectedCat = 'all';
                this.pickerLocation = null;
            }

            init() {
                this.initMap();
                this.renderCategories();
                this.populateAddForm();

                // Desktop view logic
                if (window.innerWidth > 768) {
                    document.getElementById('search-panel').classList.add('active-desktop');
                }
            }

            initMap() {
                // Main Map
                this.map = L.map('map', {
                    zoomControl: false,
                    maxBounds: CONFIG.MAX_BOUNDS,
                    maxBoundsViscosity: 1.0,
                    minZoom: 14 // Allow slight zoom out to see context, but bounded
                }).setView(CONFIG.CENTER, CONFIG.ZOOM);

                // Hybrid Layer
                L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                    maxZoom: 20,
                    subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
                }).addTo(this.map);

                L.control.zoom({ position: 'topright' }).addTo(this.map);
            }

            initPickerMap() {
                if (this.pickerMap) return;

                setTimeout(() => {
                    this.pickerMap = L.map('picker-map', {
                        zoomControl: false,
                        maxBounds: CONFIG.MAX_BOUNDS,
                        maxBoundsViscosity: 1.0,
                        minZoom: 15
                    }).setView(CONFIG.CENTER, 17);
                    L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                        maxZoom: 20,
                        subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
                    }).addTo(this.pickerMap);

                    this.pickerMap.on('move', () => {
                        const center = this.pickerMap.getCenter();
                        this.pickerLocation = center;
                        document.getElementById('location-status').innerText = `ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ≠ÿßŸÑŸä: ${center.lat.toFixed(5)}, ${center.lng.toFixed(5)}`;
                    });

                    // Initial
                    this.pickerLocation = this.pickerMap.getCenter();
                }, 300); // Delay for modal animation
            }

            renderCategories() {
                const container = document.getElementById('categories-container');
                container.innerHTML = CATEGORIES.map(cat => `
                    <div class="cat-chip ${cat.id === 'all' ? 'active' : ''}" onclick="app.selectCategory('${cat.id}', this)">
                        <span>${cat.icon}</span> ${cat.label}
                    </div>
                `).join('');

                // Add Activities select options for Search (optional, maybe later) 
            }

            selectCategory(catId, el) {
                this.selectedCat = catId;
                document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
                el.classList.add('active');

                if (catId === 'all') {
                    // Reset
                } else {
                    // Show activities bubbles or just filter list?
                    // For simply merging, let's load activities for this category
                    this.loadActivitiesForFilter(catId);
                }
            }

            loadActivitiesForFilter(catId) {
                // Show sub-categories as chips replacing the main categories? 
                // Or just append? For simplicity let's stick to main categories filtering 
                // and maybe show a list of activities to click.
                const acts = ACTIVITIES[catId];
                if (!acts) return;

                const list = document.getElementById('results-list');
                list.innerHTML = `<h3 style="margin-bottom:10px; color:var(--primary)">ÿßÿÆÿ™ÿ± ŸÜÿ¥ÿßÿ∑ÿßŸã</h3>` +
                    acts.map(act => `
                    <div class="result-item" onclick="app.searchService('${act}')" style="display:flex; align-items:center; justify-content:space-between">
                        <span style="font-weight:700">${act}</span>
                        <i class="fa-solid fa-chevron-left" style="color:var(--text-sec)"></i>
                    </div>
                `).join('');

                this.expandPanel();
            }

            handleSearch(query) {
                if (query.length < 2) return;
                // Since API searches by exact activity usually, we might need a smarter search or just fuzzy match locally if we had data.
                // The GAS script seems to take 'activity' param.
                // We'll let user type activity name.
            }

            searchService(activityName) {
                this.showLoader(true);
                this.collapsePanel(); // Show map

                fetch(`${CONFIG.SEARCH_API}?action=getProvidersByActivity&activity=${encodeURIComponent(activityName)}`)
                    .then(res => res.json())
                    .then(data => {
                        this.renderResults(data, activityName);
                    })
                    .catch(err => {
                        this.showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´: ' + err.message, 'error');
                    })
                    .finally(() => this.showLoader(false));
            }

            renderResults(data, title) {
                // Clear map
                this.markers.forEach(m => this.map.removeLayer(m));
                this.markers = [];

                const list = document.getElementById('results-list');

                if (!data || data.length === 0) {
                    list.innerHTML = `<div style="text-align:center; padding:20px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑŸÄ "${title}"</div>`;
                    this.expandPanel();
                    return;
                }

                list.innerHTML = `<h3 style="margin-bottom:10px; color:var(--success)">ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´: ${title} (${data.length})</h3>`;

                const bounds = L.latLngBounds();

                data.forEach(item => {
                    // Add Marker
                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="
                            background-color: var(--primary);
                            width: 30px; height: 30px;
                            border-radius: 50%;
                            border: 3px solid white;
                            box-shadow: 0 0 10px rgba(0,0,0,0.5);
                            display: flex; align-items: center; justify-content: center;
                            font-size: 14px;
                        ">üìç</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    });

                    const marker = L.marker([item.lat, item.lng], { icon }).addTo(this.map);
                    marker.bindPopup(`<b>${item.name}</b><br>${item.phone}`);
                    this.markers.push(marker);
                    bounds.extend([item.lat, item.lng]);

                    // Add List Item
                    const el = document.createElement('div');
                    el.className = 'result-item';
                    el.innerHTML = `
                        <div class="result-title">${item.name}</div>
                        <div class="result-meta"><i class="fa-solid fa-phone"></i> ${item.phone}</div>
                        <div class="result-meta"><i class="fa-solid fa-location-dot"></i> ${item.address}</div>
                        <div class="result-actions">
                            <button class="action-btn" onclick="app.flyTo(${item.lat}, ${item.lng})"><i class="fa-solid fa-map"></i> ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©</button>
                            <button class="action-btn" onclick="window.open('tel:${item.phone}')"><i class="fa-solid fa-phone"></i> ÿßÿ™ÿµÿßŸÑ</button>
                        </div>
                    `;
                    list.appendChild(el);
                });

                if (bounds.isValid()) this.map.fitBounds(bounds, { padding: [50, 50] });

                // On mobile, expand panel to show results briefly or keep partial
                if (window.innerWidth < 768) {
                    this.expandPanel();
                }
            }

            flyTo(lat, lng) {
                this.map.flyTo([lat, lng], 18);
                if (window.innerWidth < 768) this.collapsePanel();
            }

            // --- Panel Logic ---
            togglePanelExpand() {
                document.getElementById('search-panel').classList.toggle('expanded');
            }
            expandPanel() { document.getElementById('search-panel').classList.add('expanded'); }
            collapsePanel() { document.getElementById('search-panel').classList.remove('expanded'); }

            toggleSearchPanel() {
                const p = document.getElementById('search-panel');
                if (window.innerWidth > 768) {
                    p.classList.toggle('active-desktop');
                } else {
                    this.togglePanelExpand();
                }
            }

            // --- Add Modal ---
            openAddModal() {
                document.getElementById('add-modal').classList.add('active');
                this.initPickerMap();
            }
            closeAddModal() {
                document.getElementById('add-modal').classList.remove('active');
            }

            populateAddForm() {
                const catSelect = document.getElementById('add-category');
                CATEGORIES.forEach(c => {
                    if (c.id === 'all') return;
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.innerText = c.label;
                    catSelect.appendChild(opt);
                });
            }

            updateActivitySelect() {
                const cat = document.getElementById('add-category').value;
                const actSelect = document.getElementById('add-activity');
                actSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÜÿ¥ÿßÿ∑</option>';

                if (ACTIVITIES[cat]) {
                    ACTIVITIES[cat].forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a;
                        opt.innerText = a;
                        actSelect.appendChild(opt);
                    });
                }
            }

            submitService() {
                const name = document.getElementById('add-name').value;
                const phone = document.getElementById('add-phone').value;
                const address = document.getElementById('add-address').value;
                const activity = document.getElementById('add-activity').value;

                if (!name || !phone || !activity || !this.pickerLocation) {
                    this.showToast('Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ Ÿàÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ', 'error');
                    return;
                }

                this.showLoader(true);

                const payload = {
                    action: 'saveProvider',
                    name,
                    phone,
                    address,
                    activity,
                    lat: this.pickerLocation.lat,
                    lng: this.pickerLocation.lng
                };

                // Use fetch with no-cors or standard POST
                fetch(CONFIG.REGISTER_API, {
                    method: 'POST',
                    mode: 'no-cors', // Important for GAS execution
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).then(() => {
                    this.showToast('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠!', 'success');
                    this.closeAddModal();
                    // Clear form
                    document.getElementById('add-name').value = '';
                    document.getElementById('add-phone').value = '';
                    document.getElementById('add-address').value = '';
                }).catch(e => {
                    this.showToast('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ', 'error');
                    console.error(e);
                }).finally(() => this.showLoader(false));
            }

            // --- Utilities ---
            showLoader(show) {
                document.getElementById('loader').classList.toggle('active', show);
            }
            showToast(msg, type) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.className = `toast show ${type}`;
                setTimeout(() => t.classList.remove('show'), 3000);
            }
        }

        const app = new App();
        window.addEventListener('load', () => app.init());

    </script>
</body>

</html>
